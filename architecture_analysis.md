# Архитектура и методология сбора данных Bitcoin Collector

## Архитектура системы

### Основные компоненты

1. **CollectorConfig** - централизованная конфигурация
   - URL API, задержки, таймауты
   - Параметры параллелизма и батчинга
   - Настройки retry-логики

2. **Модели данных**
   - `AddressData` - информация об адресах
   - `TransactionData` - детали транзакций
   - Поддержка JSON сериализации

3. **WalletExplorerAPI** - HTTP клиент
   - Retry стратегия с экспоненциальным backoff
   - Обработка rate limiting (429 ошибки)
   - Таймауты и user-agent заголовки

4. **DataPersistence** - управление данными
   - Атомарные операции записи
   - Загрузка обработанных данных
   - CSV формат с JSON для сложных полей

5. **BitcoinDataCollector** - основной оркестратор
   - Инкрементальная обработка
   - Параллельное выполнение
   - Управление жизненным циклом

## Методология сбора данных

### Принципы проектирования

1. **Инкрементальность**
   - Отслеживание обработанных адресов/транзакций
   - Пропуск уже собранных данных
   - Восстановление после сбоев

2. **Батчевая обработка**
   - Адреса: батчи по 20 записей
   - Транзакции: батчи по 100 записей
   - Периодическое сохранение промежуточных результатов

3. **Параллелизм**
   - ThreadPoolExecutor для адресов
   - Настраиваемое количество воркеров (по умолчанию 5)
   - Последовательная обработка транзакций (избежание дублирования)

4. **Устойчивость**
   - Retry с экспоненциальным backoff
   - Обработка HTTP ошибок (429, 5xx)
   - Graceful degradation при сбоях

5. **Rate Limiting**
   - Настраиваемые задержки между запросами
   - Автоматическое увеличение задержки при 429
   - User-Agent ротация

### Поток данных

```
CSV Input → Address Collection → Transaction Details → CSV Output
    ↓              ↓                    ↓
Load Processed → API Calls → Batch Save → Final Save
```

### Алгоритм работы

1. **Инициализация**
   - Загрузка обработанных адресов/транзакций
   - Создание HTTP сессии с retry

2. **Сбор адресов**
   - Фильтрация новых адресов
   - Параллельные API вызовы
   - Батчевое сохранение

3. **Сбор транзакций**
   - Извлечение уникальных txid
   - Последовательная обработка
   - Обогащение данных

4. **Персистентность**
   - Атомарные операции записи
   - JSON сериализация сложных полей
   - Восстановление состояния

### Конфигурация

```python
CollectorConfig(
    base_url="https://www.walletexplorer.com",
    delay=1.0,                    # Задержка между запросами
    max_workers=5,               # Параллельные воркеры
    batch_size=20,               # Размер батча адресов
    transaction_batch_size=100,  # Размер батча транзакций
    timeout=30,                  # Таймаут запросов
    max_retries=3,              # Количество повторов
    backoff_factor=0.3          # Коэффициент backoff
)
```

### Обработка ошибок

- **HTTP ошибки**: retry с backoff
- **Rate limiting**: увеличение задержки
- **Сетевые ошибки**: логирование и продолжение
- **Данные**: валидация и fallback значения

### Производительность

- **Параллелизм**: до 5 одновременных запросов
- **Батчинг**: минимизация I/O операций
- **Кэширование**: отслеживание обработанных данных
- **Оптимизация**: пропуск дубликатов
